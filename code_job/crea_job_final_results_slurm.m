clear all 
close all
clc

% Gestione deelle differenti piattaforme da cui si chiama il codice

base_directory = '/nfsd/biopetmri/BACKUP/Users/Marco/3T_Verona/SEL_candidates';
% ALTERNATIVA PC LOCALE 
%base_directory = 'F:\Utente\TESI\';

output_path=fullfile(base_directory,'output');
output_summury=fullfile(base_directory,'output_summary');

% elenco soggetti
list_output=dir(output_path);
jobdir=fullfile(base_directory,'code','Jobs');
if not(exist(jobdir,'dir'))
    mkdir(jobdir)
end
filename_qsub=fullfile(base_directory,'code','Jobs',['Results_' datestr(now,30) '.txt']);
ID_file_recap=fopen(filename_qsub,'w');

jobdir=fullfile(base_directory,'code','Jobs','Exex_results');
if not(exist(jobdir,'dir'))
    mkdir(jobdir)
end
fprintf(ID_file_recap,['cd ' strrep(jobdir,'\','/') ' \n']);

jobMatlabName=['M_finale.m'];
                 
ID_file=fopen(fullfile(jobdir, jobMatlabName),'wt');

fprintf(ID_file,['clear all\n' ...
    'close all\n' ...
    'clc\n' ...
    '\n' ...
    'base_directory = ''/nfsd/biopetmri/BACKUP/Users/Marco/3T_Verona/SEL_candidates'';\n' ...
    '\n' ...
    'output_path=fullfile(base_directory,''output'');\n' ...
    '\n' ...
    'output_summury=fullfile(base_directory,''output_summary'');\n' ...
    '\n' ...
    'list_output=dir(output_path);\n' ...
    'dim=length(list_output)-2;\n' ...
    '\n' ...
    'sienapd_FLAIR = zeros(1,dim);\n' ...
        'sienapd_T2 = zeros(1,dim);\n' ...
        'robust_FLAIR = zeros(1,dim);\n' ...
        'robust_T2 = zeros(1,dim);\n' ...
        '\n' ...
    'resampled = zeros(1,dim);\n' ...
        'volume_sienapd_FLAIR = zeros(1,dim);\n' ...
        'volume_sienapd_T2 = zeros(1,dim);\n' ...
        'volume_robust_FLAIR = zeros(1,dim);\n' ...
        'volume_robust_T2 = zeros(1,dim);\n' ...
        'volume_resampled = zeros(1,dim);\n' ...
        '\n' ...
        'k = 1;\n' ...
        '\n' ...
    'result_sienapd = zeros(4,dim);\n' ...
        'result_robust = zeros(4,dim);\n' ...
        'result_resampled = zeros(4,dim);\n' ...
        '\n' ...
    'for t=3:1:length(list_output)\n' ...
        '\n' ...
        'subjID_output = list_output(t).name;\n' ....
        'subj_path_output= fullfile(output_path, subjID_output));\n' ...
        'subj_output_list=dir(subj_path_output);\n' ...
        '\n' ...
        '\n' ...
        'CC_SEL_sienapd_FLAIR = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_sienapd'',''FLAIR_T1'',''Jacobian'',''num_CC_SEL_FLAIR.mat''));\n'...
        'volume_SEL_sienapd_FLAIR = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_sienapd'',''FLAIR_T1'',''Jacobian'',''volume.mat''));\n' ...
        '\n' ...
        'sienapd_FLAIR(1,k) = CC_SEL_sienapd_FLAIR.num_CC_SEL_FLAIR;\n' ...
        'volume_sienapd_FLAIR(1,k) = volume_SEL_sienapd_FLAIR.volume;\n' ... 
        '\n' ...
        '\n' ...
        'CC_SEL_sienapd_T2 = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_sienapd'',''T2_T1'',''Jacobian'',''num_CC_SEL_T2.mat''));\n'...
        'volume_SEL_sienapd_T2 = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_sienapd'',''T2_T1'',''Jacobian'',''volume.mat''));\n' ...
        '\n' ...
        'sienapd_T2(1,k) = CC_SEL_sienapd_T2.num_CC_SEL_T2;\n' ...
        'volume_sienapd_T2(1,k) = volume_SEL_sienapd_T2.volume;\n' ...
        '\n' ...
        '\n' ...
        'CC_SEL_robust_FLAIR = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_robust_template'',''FLAIR_T1'',''Jacobian'',''num_CC_SEL_FLAIR.mat''));\n'...
        'volume_SEL_robust_FLAIR = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_robust_template'',''FLAIR_T1'',''Jacobian'',''volume.mat''));\n' ...
        '\n' ... 
        'robust_FLAIR(1,k) = CC_SEL_robust_FLAIR.num_CC_SEL_FLAIR;\n' ...
        'volume_robust_FLAIR(1,k) = volume_SEL_robust_FLAIR.volume;\n' ...
        '\n' ...
        '\n' ...
        'CC_SEL_robust_T2 = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_robust_template'',''T2_T1'',''Jacobian'',''num_CC_SEL_T2.mat''));\n'...
        'volume_SEL_robust_T2 = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_robust_template'',''T2_T1'',''Jacobian'',''volume.mat''));\n' ...
        '\n' ...
        'robust_T2(1,k) = CC_SEL_robust_T2.num_CC_SEL_T2;\n' ...
        'volume_robust_T2(1,k) = volume_SEL_robust_T2.volume;\n' ...
        '\n' ...
        '\n' ...
        'CC_SEL = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_resampled'',''Jacobian'',''num_CC_SEL_FLAIR.mat''));\n'...
        'volume_SEL = load(fullfile(subj_path_output,subj_output_list(3).name,''registration_resampled'',''Jacobian'',''volume.mat''));\n' ...
        '\n' ...
        'resampled(1,k) = CC_SEL.num_CC_SEL;\n' ...
        'volume_resampled(1,k) = volume_SEL.volume;\n' ...
        '\n' ...
        'k = k+1;\n' ...  
        'end\n' ...
    '\n' ...
    'result_sienapd = [sienapd_FLAIR ; volume_sienapd_FLAIR ; sienapd_T2 ; volume_sienapd_T2];\n' ...
    'result_robust = [robust_FLAIR ; volume_robust_FLAIR ; robust_T2 ; volume_robust_T2];\n' ... 
    'result_resampled = [robust_FLAIR ; volume_robust_FLAIR ; resampled ; volume_resampled];\n' ...
    '\n' ...
    '\n' ...
    'save(fullfile(output_summury,''result_sienapd''), ''result_sienapd'');' '\n' ...
    'save(fullfile(output_summury,''result_robust''), ''result_robust'');' '\n' ...
    'save(fullfile(output_summury,''result_resampled''), ''result_resampled'');' ]);

fclose(ID_file);


%%
                jobName=['JD_finale.job'];
                ID_file=fopen(fullfile(jobdir, jobName),'wt');
                
                fprintf(ID_file,['#!/bin/bash\n'...
                    '#SBATCH --output ' jobName '.o%%j.txt\n'...
                    '#SBATCH --error ' jobName '.e%%j.txt\n'...
                    '#SBATCH --mail-user palombagia@dei.unipd.it\n'...
                    '#SBATCH --mail-type ALL\n'...
                    '#SBATCH --ntasks 1\n'...
                    '#SBATCH -c 4\n'...
                    '#SBATCH --exclude=gpu1,gpu2,runner-07,runner-08,runner-13,runner-14,runner-15,runner-16,runner-17,runner-18,runner-19\n'... 
                    '#SBATCH --partition allgroups\n'...
                    '#SBATCH --mem 16G\n'...
                    '\n' ...
                    'pushd ' strrep(fullfile(jobdir),'\','/') '\n' ...
                    'matlab -nodisplay -nosplash -r "' strrep(jobMatlabName,'.m','')  ';exit" ']);
                
                fclose(ID_file);

                fprintf(ID_file_recap,['sbatch ' strrep(fullfile(jobdir,jobName),'\','/') '\n']);
               
                fclose(ID_file_recap)
                
             